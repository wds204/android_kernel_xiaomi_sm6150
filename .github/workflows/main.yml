name: Build Sweet Kernel

on:
  push:
    branches:
      - bpf  # Change if you use another branch

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout source
      uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y git build-essential bc ccache flex bison libncurses5 libncurses5-dev unzip wget tar

    - name: Download toolchain
      run: |
        mkdir -p ~/toolchain && cd ~/toolchain
        wget https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_aarch64_aarch64-linux-android-4.9/releases/download/4.9/aarch64-linux-android-4.9.tar.xz
        tar xf aarch64-linux-android-4.9.tar.xz

    - name: Export environment
      run: |
        export ARCH=arm64
        export CROSS_COMPILE=~/toolchain/aarch64-linux-android-4.9/bin/aarch64-linux-android-
        export KBUILD_OUTPUT=out

    - name: Configure kernel
      run: |
        make O=out sweet_defconfig

    - name: Build kernel
      run: |
        make -j$(nproc) O=out

    - name: Package kernel for TWRP
      run: |
        mkdir -p kernel_zip
        cp out/arch/arm64/boot/Image.gz-dtb kernel_zip/
        cd kernel_zip
        zip -r sweet_kernel.zip Image.gz-dtb
        mv sweet_kernel.zip ../

    - name: Upload kernel artifact
      uses: actions/upload-artifact@v4
      with:
        name: sweet_kernel
        path: sweet_kernel.zip
