steps:
  - name: Checkout Kernel Source
    uses: actions/checkout@v4
    with:
      # Checks out the repository where this workflow file is located
      ref: ${{ github.event.inputs.branch }}
      path: kernel

  - name: Install Build Dependencies
    # Install necessary packages for kernel compilation (flex, bison, ncurses, etc.)
    run: |
      sudo apt update
      sudo apt install -y ccache git xz-utils flex bison libssl-dev libncurses5-dev bc

  - name: Setup Toolchain (AOSP Clang - Robust Method)
    # CRITICAL FIX: We clone a reliable toolchain mirror instead of relying on a single, potentially broken download link.
    run: |
      cd kernel
      echo "Cloning Clang toolchain mirror..."
      # Clone the toolchain quickly (depth=1) into the 'clang' directory
      git clone https://github.com/kdrag0n/aosp-toolchain-clang.git --depth=1 clang
      
      # Set the PATH to include the Clang binaries
      export PATH="$(pwd)/clang/bin:$PATH"
      echo "PATH=$(pwd)/clang/bin:$PATH" >> $GITHUB_ENV
      
      # Verify clang is available
      clang --version

  - name: Set up Environment Variables
    run: |
      # Set cross-compilation variables for Clang/LLVM
      echo "CC=clang" >> $GITHUB_ENV
      echo "LD=ld.lld" >> $GITHUB_ENV
      echo "CLANG_TRIPLE=aarch64-linux-gnu-" >> $GITHUB_ENV
      echo "CROSS_COMPILE=aarch64-linux-gnu-" >> $GITHUB_ENV
      echo "CROSS_COMPILE_ARM32=arm-linux-gnueabi-" >> $GITHUB_ENV
      
  - name: Generate Kernel Configuration
    run: |
      cd kernel
      mkdir -p out
      # Generate the .config file from the specified defconfig
      make O=out ${{ env.KERNEL_CONFIG }}

  - name: Compile the Kernel
    # Start the actual compilation process using all available cores
    run: |
      cd kernel
      make -j$(nproc) O=out

  - name: Locate and Package Output
    run: |
      cd kernel
      # Find the main kernel image file
      KERNEL_IMAGE=$(find out/arch/${{ env.ARCH }}/boot -name "Image*" -o -name "zImage*" -o -name "bzImage*" | head -n 1)
      
      if [ -f "$KERNEL_IMAGE" ]; then
        echo "Kernel Image found at: $KERNEL_IMAGE"
        mkdir -p ${{ github.workspace }}/artifacts
        cp $KERNEL_IMAGE ${{ github.workspace }}/artifacts/$(basename $KERNEL_IMAGE)
        
        if [ -d "out/lib/modules" ]; then
            cp -r out/lib/modules ${{ github.workspace }}/artifacts/modules
        fi
        
      else
        echo "::error::Kernel Image not found after compilation."
        exit 1
      fi

  - name: Upload Kernel Artifact
    uses: actions/upload-artifact@v4
    with:
      name: ${{ github.event.repository.name }}_${{ github.event.inputs.branch }}_kernel
      path: ${{ github.workspace }}/artifacts/*
      retention-days: 7
