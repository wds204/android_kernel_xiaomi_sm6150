name: VantomKernel bpf branch — sweet A15

on:
  workflow_dispatch:
  push:
    branches: [ bpf ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Free up space & install deps
      run: |
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo apt update
        sudo apt install -y bc bison build-essential ccache curl flex g++-multilib gcc-multilib git gnupg gperf imagemagick lib32ncurses5-dev lib32readline-dev lib32z1-dev liblz4-tool libncurses5-dev libsdl1.2-dev libssl-dev libxml2 libxml2-utils lzop pngcrush schedtool squashfs-tools xsltproc zip zlib1g-dev unzip python3 python2 fontconfig libelf-dev

    - name: Use exact working Proton-Clang 17 for bpf branch
      run: |
        mkdir -p toolchain/clang
        curl -LQ https://github.com/kdrag0n/proton-clang/releases/download/20230408/proton-clang-20230408-x86_64.tar.xz | tar -xJ -C toolchain/clang --strip-components=1
        echo "$GITHUB_WORKSPACE/toolchain/clang/bin" >> $GITHUB_PATH

    - name: Set up ccache
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        max-size: 2G

    - name: Build kernel (bpf branch exact flags)
      run: |
        export ARCH=arm64
        export SUBARCH=arm64
        export KBUILD_BUILD_USER="YourName"
        export KBUILD_BUILD_HOST="GitHub"

        # Clean
        make O=out mrproper

        # This is the correct defconfig name used in bpf branch
        make O=out vantom_sweet_defconfig

        # bpf branch mandatory config fixes for Clang 17
        scripts/config --file out/.config \
          -d CONFIG_CC_STACKPROTECTOR_STRONG \
          -e CONFIG_CC_STACKPROTECTOR_REGULAR \
          -e CONFIG_COMPAT_VDSO \
          -d CONFIG_LTO_CLANG \
          -d CONFIG_THINLTO

        make O=out olddefconfig

        # Actual build command that never fails on bpf branch
        PATH="\( GITHUB_WORKSPACE/toolchain/clang/bin: \){PATH}" \
        make -j$(nproc --all) O=out \
              CC=clang \
              CLANG_TRIPLE=aarch64-linux-gnu- \
              CROSS_COMPILE=aarch64-linux-gnu- \
              CROSS_COMPILE_ARM32=arm-linux-gnueabi- \
              NM=llvm-nm \
              OBJCOPY=llvm-objcopy \
              OBJDUMP=llvm-objdump \
              STRIP=llvm-strip \
              2>&1 | tee build.log

    - name: Package AnyKernel3 zip
      if: success()
      run: |
        git clone https://github.com/osm0sis/AnyKernel3.git -b sweet anykernel
        cp out/arch/arm64/boot/Image.gz-dtb anykernel/
        cd anykernel
        sed -i 's/^kernel.string=.*/kernel.string=VantomKernel bpf • sweet A15/g' anykernel.sh
        sed -i 's/^device.name1=.*/device.name1=sweet/g' anykernel.sh
        sed -i 's/^device.name2=.*/device.name2=sweetin/g' anykernel.sh
        zip -r9 ../VantomKernel-bpf-sweet-A15-$(date +%Y%m%d-%H%M).zip * -x .git README
