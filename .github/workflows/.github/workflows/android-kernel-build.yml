name: Build VantomKernel for Sweet (A15)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Manual trigger

jobs:
  build:
    runs-on: ubuntu-latest
    container: ubuntu:22.04  # Ensures clean env

    steps:
    - name: Checkout Kernel Source
      uses: actions/checkout@v4
      with:
        submodules: true  # If you have submodules like AnyKernel3

    - name: Install Dependencies
      run: |
        apt-get update
        apt-get install -y git-core gnupg flex bison build-essential zip curl zlib1g-dev gcc-multilib g++-multilib libc6-dev-i386 libncurses5 lib32ncurses5-dev x11proto-core-dev libx11-dev lib32z1-dev libgl1-mesa-dev libxml2-utils xsltproc unzip fontconfig python3 bc ccache libssl-dev repo

    - name: Setup ccache
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        max-size: 1G
      env:
        CCACHE_DIR: ${{ runner.temp }}/ccache

    - name: Download Proton-Clang
      run: |
        git clone --depth=1 https://github.com/kdrag0n/proton-clang clang
        echo "$GITHUB_WORKSPACE/clang/bin" >> $GITHUB_PATH

    - name: Prepare Config
      run: |
        export ARCH=arm64
        export SUBARCH=arm64
        export O=out
        make O=out sweet_defconfig  # Adjust to vendor/sweet_defconfig if needed
        # For A15: Ensure config has CONFIG_MODULES=y and any GKI flags if your fork requires

    - name: Build Kernel
      run: |
        export PATH="\( GITHUB_WORKSPACE/clang/bin: \){PATH}"
        export CC="ccache clang"
        export CLANG_TRIPLE=aarch64-linux-gnu-
        export CROSS_COMPILE=aarch64-linux-gnu-
        export CROSS_COMPILE_ARM32=arm-linux-gnueabi-
        make -j$(nproc) O=out \
          CC=clang \
          NM=llvm-nm \
          STRIP=llvm-strip \
          OBJCOPY=llvm-objcopy \
          OBJDUMP=llvm-objdump \
          CCACHE=ccache \
          V=1  # Verbose for debugging

    - name: Package with AnyKernel3
      if: success()  # Only if build succeeds
      run: |
        # Assumes AnyKernel3 is cloned in repo root as 'anykernel' dir
        cp out/arch/arm64/boot/Image.gz-dtb anykernel/Image.gz-dtb  # Or just 'Image' if no dtb
        cd anykernel
        # Edit anykernel.sh for your details: kernel name, version, etc.
        sed -i 's/KERNELNAME="VantomKernel"/KERNELNAME="YourVantomFork"/g' anykernel.sh
        sed -i 's/VERSION="r1"/VERSION="A15-r1"/g' anykernel.sh  # Customize
        zip -r9 ../VantomKernel-sweet-A15-$(date +%Y%m%d).zip * -x .git README.md *placeholder
        cd ..

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: VantomKernel-A15-Zip
        path: |
          VantomKernel-sweet-A15-*.zip
          out/arch/arm64/boot/Image.gz-dtb  # Raw image too
        retention-days: 30

    - name: Notify on Failure
      if: failure()
      run: echo "Build failed! Check logs for errors (e.g., missing A15 patches)."
